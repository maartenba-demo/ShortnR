<?xml version="1.0" encoding="UTF-8"?>
<project name="ShortnR" default="deploy-inplace">
    <target name="properties" description="Determine target environment">
        <propertyprompt promptText="Which environment do you want to deploy to?" propertyName="environment" defaultValue="local" useExistingValue="true" />

        <property file="./deploy/${environment}.properties" />
    </target>

    <target name="versioning" description="Versioning">
        <version file="${deployment.versionfile}" releasetype="Bugfix" property="deployment.version" />
    </target>

    <target name="dbmigrate-setupdbdeploy" description="Database Migrations - Setup dbdeploy" depends="properties">
        <exec command="${tools.mysql} -h${database.host} -P${database.port} -u${database.username} -p${database.password} ${database.database} &lt; ${dbdeploy.initscript}"
              dir="./"
              checkreturn="true" />
        <echo message="Created dbdeploy changelog table"/>
    </target>

    <target name="dbmigrate" description="Database Migrations" depends="properties,dbmigrate-setupdbdeploy">
        <tstamp/>

        <taskdef name="dbdeploy" classname="phing.tasks.ext.dbdeploy.DbDeployTask"/>

        <property name="dbdeploy.deployfile" value="${dbdeploy.scripts}/deploy-${deployment.version}-${DSTAMP}${TSTAMP}.sql" />
        <property name="dbdeploy.undofile" value="${dbdeploy.scripts}/undo-${deployment.version}-${DSTAMP}${TSTAMP}.sql" />

        <dbdeploy
                url="mysql:host=${database.host};port=${database.port};dbname=${database.database}"
                userid="${database.username}"
                password="${database.password}"
                dir="${dbdeploy.deltas}"
                outputfile="${dbdeploy.deployfile}"
                undooutputfile="${dbdeploy.undofile}" />

        <exec command="${tools.mysql} -h${database.host} -P${database.port} -u${database.username} -p${database.password} ${database.database} &lt; ${dbdeploy.deployfile}"
              dir="./"
              checkreturn="true" />
    </target>

    <target name="updateconfig" depends="properties" description="Create config.php">
        <copy file="${path.application}/config.php.template" tofile="${path.application}/config.php" overwrite="true" haltonerror="true">
            <filterchain>
                <replacetokens begintoken="#" endtoken="#">
                    <token key="application.rooturl" value="${application.rooturl}" />
                    <token key="database.host" value="${database.host}" />
                    <token key="database.port" value="${database.port}" />
                    <token key="database.database" value="${database.database}" />
                    <token key="database.username" value="${database.username}" />
                    <token key="database.password" value="${database.password}" />
                </replacetokens>
            </filterchain>
        </copy>

        <echo message="Updated configuration file." />
    </target>

    <target name="deploy-inplace" depends="properties,updateconfig" description="In-place deployment">
        <echo message="Finished deployment." />
    </target>

    <target name="deploy-ftp" depends="properties,versioning,dbmigrate,updateconfig" description="FTP deployment">
        <ftpdeploy host="${deployment.ftp.server}" port="${deployment.ftp.port}" username="${deployment.ftp.username}" password="${deployment.ftp.password}"
                   dir="/site/application/" mode="binary" clearFirst="true">
            <fileset dir="${path.application}">
                <include name="**"></include>
            </fileset>
        </ftpdeploy>
        <ftpdeploy host="${deployment.ftp.server}" port="${deployment.ftp.port}" username="${deployment.ftp.username}" password="${deployment.ftp.password}"
                   dir="/site/wwwroot/" mode="binary" clearFirst="true">
            <fileset dir="${path.public}">
                <include name="**"></include>
            </fileset>
        </ftpdeploy>
    </target>

    <target name="deploy-local" depends="properties,updateconfig" description="Local deployment">
        <copy todir="${deployment.filesystem.target}/application">
            <fileset dir="${path.application}">
                <include name="**"></include>
            </fileset>
        </copy>
        <copy todir="${deployment.filesystem.target}/public">
            <fileset dir="${path.public}">
                <include name="**"></include>
            </fileset>
        </copy>
    </target>

    <target name="gittag">
        <!-- This is possible... -->
        <gittag repository="./" name="ver1.0" force="true"/>
    </target>
</project>
